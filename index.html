<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kreator Wniosku o Umowę Ramową</title>

  <!-- Ładowanie czcionki dla strony HTML -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Zewnętrzne biblioteki do generowania PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf-autotable.umd.min.js"></script>
  
  <!-- Style CSS dla kreatora -->
  <style>
    :root { 
        --primary: #d90000; 
        --primary-light: #fef2f2;
        --secondary: #1f2937;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-500: #6b7280;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --green-500: #22c55e;
        --red-500: #ef4444;
    }
    *, :before, :after { box-sizing: border-box; }
    body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--gray-100); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 2rem 1rem; }
    
    .wizard-container { width: 100%; max-width: 64rem; background-color: #ffffff; border-radius: 1rem; overflow: hidden; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); display: flex; flex-direction: column; max-height: 90vh; }
    
    .progress-bar { display: flex; padding: 1rem 2rem; border-bottom: 1px solid var(--gray-200); background-color: #fff; flex-shrink: 0; }
    .progress-step { flex: 1; text-align: center; position: relative; }
    .progress-step .step-circle { width: 2.5rem; height: 2.5rem; border-radius: 50%; background-color: var(--gray-200); color: var(--gray-500); display: flex; align-items: center; justify-content: center; font-weight: 600; margin: 0 auto; transition: all 0.3s ease; border: 2px solid transparent; }
    .progress-step .step-label { margin-top: 0.5rem; font-size: 0.8rem; font-weight: 500; color: var(--gray-500); transition: all 0.3s ease; }
    .progress-step:not(:last-child)::after { content: ''; position: absolute; top: 1.25rem; left: 50%; width: 100%; height: 2px; background-color: var(--gray-200); transform: translateY(-50%); z-index: -1; }
    
    .progress-step.active .step-circle { background-color: var(--primary-light); color: var(--primary); border-color: var(--primary); }
    .progress-step.active .step-label { color: var(--primary); font-weight: 600; }
    .progress-step.completed .step-circle { background-color: var(--primary); color: #fff; }
    .progress-step.completed .step-label { color: var(--gray-800); }
    .progress-step.completed:not(:last-child)::after { background-color: var(--primary); }

    .form-body { padding: 1.5rem 3rem; overflow-y: auto; flex-grow: 1; }
    .form-step { display: none; }
    .form-step.active { display: block; animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .form-section-header { font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; color: var(--secondary); }
    .subsection { margin-bottom: 2.5rem; }
    .subsection-header { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--gray-200); }
    
    .form-grid { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 1.5rem 2rem; }
    @media (min-width: 768px) { .form-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    .grid-col-span-2 { grid-column: span 2 / span 2; }
    .form-label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; color: #374151; }
    .form-label.required:after { content: " *"; color: var(--red-500); }
    .input-field, select.input-field, textarea.input-field { width: 100%; padding: 0.5rem 1rem; background-color: #f9fafb; border: 1px solid #d1d5db; border-radius: 0.5rem; transition: all 0.2s; }
    .input-field:focus, select.input-field:focus, textarea.input-field:focus { outline: 2px solid transparent; outline-offset: 2px; border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-light); }
    .input-field.is-invalid { border-color: var(--red-500); background-color: #fee2e2; }
    .dynamic-row { position: relative; margin-bottom: 0.75rem; padding: 1.25rem; padding-top: 2.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; background-color: #fafafa; }
    .btn-remove { position: absolute; top: 0.5rem; right: 0.5rem; padding: 0.25rem 1rem; background-color: #dc2626; color: white; font-weight: 600; border-radius: 0.375rem; transition: background-color 0.2s; cursor: pointer; border: none; }
    .btn-remove:hover { background-color: #b91c1c; }
    .btn-add { padding: 0.25rem 1rem; background-color: #16a34a; color: white; font-weight: 600; border-radius: 0.375rem; transition: background-color 0.2s; cursor: pointer; border: none; }
    .btn-add:hover { background-color: #15803d; }
    
    .form-footer { padding: 1.5rem 3rem; border-top: 1px solid var(--gray-200); background-color: #fff; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .btn { padding: 0.75rem 2rem; font-weight: 600; border-radius: 0.5rem; transition: all 0.2s; cursor: pointer; border: none; }
    .btn-secondary { background-color: var(--gray-200); color: var(--gray-800); }
    .btn-secondary:hover { background-color: #d1d5db; }
    .btn-primary { background-color: var(--primary); color: #ffffff; }
    .btn-primary:hover { background-color: #b90000; }
    .btn:disabled { background-color: #d1d5db; cursor: not-allowed; }
    .btn-generate { background-color: var(--green-500); color: #fff; }
    .btn-generate:hover { background-color: #16a34a; }

    .final-step-content { text-align: center; padding: 4rem 2rem; }
    .final-step-content svg { width: 5rem; height: 5rem; color: var(--green-500); margin: 0 auto 1.5rem; }
    .final-step-content h2 { font-size: 2rem; font-weight: 700; color: var(--secondary); margin-bottom: 1rem; }
    .final-step-content p { color: var(--gray-500); margin-bottom: 2rem; max-width: 500px; margin-left: auto; margin-right: auto; }

    #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); }
    .loader-spinner { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="loader-overlay"><div class="loader-spinner"></div></div>

  <div class="wizard-container">
    <div class="progress-bar" id="progressBar"></div>

    <form id="applicationForm" class="form-body" novalidate>
      
      <!-- Krok 1: Dane Wnioskodawcy -->
      <div class="form-step active" data-step="1" data-label="Dane Wnioskodawcy">
        <h2 class="form-section-header">Krok 1: Dane Wnioskodawcy</h2>
        <div class="subsection">
          <h3 class="subsection-header">Dane adresowe</h3>
          <div class="form-grid">
            <div><label for="nip" class="form-label required">NIP</label><input type="text" id="nip" name="nip" required class="input-field" /></div>
            <div><label for="regon" class="form-label">REGON</label><input type="text" id="regon" name="regon" class="input-field" /></div>
            <div class="grid-col-span-2"><label for="fullName" class="form-label required">Pełna nazwa firmy</label><input type="text" id="fullName" name="fullName" required class="input-field" /></div>
            <div class="grid-col-span-2"><p class="form-label required">Adres siedziby</p></div>
            <div><label for="street" class="form-label required">Ulica</label><input type="text" id="street" name="street" required class="input-field" /></div>
            <div><label for="building_number" class="form-label required">Numer domu</label><input type="text" id="building_number" name="building_number" required class="input-field" /></div>
            <div><label for="postal_code" class="form-label required">Kod pocztowy</label><input type="text" id="postal_code" name="postal_code" required class="input-field" /></div>
            <div><label for="city" class="form-label required">Miejscowość</label><input type="text" id="city" name="city" required class="input-field" /></div>
            <div><label for="phone" class="form-label required">Telefon</label><input type="tel" id="phone" name="phone" required class="input-field" /></div>
            <div><label for="email" class="form-label required">E-mail</label><input type="email" id="email" name="email" required class="input-field" /></div>
          </div>
        </div>
        <div class="subsection">
          <h3 class="subsection-header">Reprezentacja i kontakt</h3>
           <div class="form-grid">
              <div class="grid-col-span-2"><label for="rep_name" class="form-label required">Imię i nazwisko osoby reprezentującej</label><input type="text" id="rep_name" required class="input-field"></div>
              <div><label for="rep_phone" class="form-label required">Telefon</label><input type="tel" id="rep_phone" required class="input-field"></div>
              <div><label for="rep_email" class="form-label required">Adres e-mail</label><input type="email" id="rep_email" required class="input-field"></div>
           </div>
        </div>
      </div>

      <!-- Krok 2: Informacje o Firmie -->
      <div class="form-step" data-step="2" data-label="O Firmie">
        <h2 class="form-section-header">Krok 2: Informacje o Firmie</h2>
        <div class="subsection">
            <h3 class="subsection-header">Właściciele / udziałowcy</h3>
            <div id="owners-container"></div>
            <button type="button" class="btn-add" data-template="owner-template" data-container="owners-container">+ Dodaj właściciela</button>
        </div>
         <div class="subsection">
            <h3 class="subsection-header">Wnioskowany limit poręczeń</h3>
            <div class="form-grid">
                <label for="limit_wadialny" class="form-label">Wadialny</label>
                <input type="text" id="limit_wadialny" class="input-field">
                <label for="limit_kontrakt" class="form-label">Kontraktowy</label>
                <input type="text" id="limit_kontrakt" class="input-field">
            </div>
        </div>
      </div>

      <!-- Krok 3: Finanse -->
      <div class="form-step" data-step="3" data-label="Finanse">
        <h2 class="form-section-header">Krok 3: Sytuacja Finansowa</h2>
        <div class="subsection">
            <h3 class="subsection-header">Posiadane rachunki bankowe</h3>
            <div id="accounts-container"></div>
            <button type="button" class="btn-add" data-template="account-template" data-container="accounts-container">+ Dodaj rachunek</button>
        </div>
        <div class="subsection">
            <h3 class="subsection-header">Posiadane kredyty / pożyczki</h3>
             <div id="credits-container"></div>
             <button type="button" class="btn-add" data-template="credit-template" data-container="credits-container">+ Dodaj zobowiązanie</button>
        </div>
      </div>

      <!-- Krok 4: Oświadczenia -->
      <div class="form-step" data-step="4" data-label="Oświadczenia">
        <h2 class="form-section-header">Krok 4: Oświadczenia</h2>
        <p>Proszę potwierdzić poniższe oświadczenie, aby kontynuować.</p>
        <div style="margin-top: 2rem; padding: 1rem; background-color: var(--primary-light); border-radius: 0.5rem;">
             <label style="display: flex; align-items: flex-start; gap: 0.75rem;">
                <input type="checkbox" name="master_consent" required style="margin-top: 5px;">
                <span style="font-size: 0.9rem;">
                    <strong>Oświadczam, że zapoznałem/am się z regulaminem i akceptuję jego treść, a wszystkie podane dane są zgodne z prawdą.</strong>
                </span>
            </label>
        </div>
      </div>
      
      <!-- Krok 5: Podsumowanie -->
      <div class="form-step" data-step="5" data-label="Podsumowanie">
        <div class="final-step-content">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h2>Wniosek gotowy!</h2>
            <p>Wszystkie dane zostały wprowadzone. Kliknij poniższy przycisk, aby wygenerować i pobrać wniosek w formacie PDF.</p>
        </div>
      </div>

    </form>

    <div class="form-footer" id="navigation">
      <button type="button" class="btn btn-secondary" id="prevBtn">Wstecz</button>
      <button type="button" class="btn btn-primary" id="nextBtn">Dalej</button>
      <button type="button" id="generatePdf" class="btn btn-generate" style="display: none;">Generuj PDF</button>
    </div>
  </div>
  
  <!-- Szablony dla dynamicznych sekcji -->
  <template id="owner-template"><div class="dynamic-row form-grid"><div class="grid-col-span-2"><label class="form-label">Nazwisko / nazwa</label><input type="text" name="owner_name[]" class="input-field"></div><div><label class="form-label">Udziały (%)</label><input type="number" name="owner_shares_percent[]" class="input-field" min="0" max="100"></div><button type="button" class="btn-remove">Usuń</button></div></template>
  <template id="account-template"><div class="dynamic-row form-grid"><div><label class="form-label">Nazwa banku</label><input type="text" name="bank_name[]" required class="input-field"></div><div><label class="form-label">Numer rachunku</label><input type="text" name="account_number[]" required class="input-field"></div><button type="button" class="btn-remove">Usuń</button></div></template>
  <template id="credit-template"><div class="dynamic-row form-grid"><div class="grid-col-span-2"><label class="form-label">Nazwa banku</label><input type="text" name="credit_bank[]" class="input-field"></div><div><label class="form-label">Kwota do spłaty</label><input type="text" name="credit_amount[]" class="input-field"></div><button type="button" class="btn-remove">Usuń</button></div></template>

  <!-- Skrypt JavaScript -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            currentStep: 1,
            totalSteps: 0,
            
            init() {
                this.form = document.getElementById('applicationForm');
                this.loader = document.getElementById('loader-overlay');
                this.initWizard();
                document.getElementById('generatePdf').addEventListener('click', () => this.generatePdf());

                this.form.addEventListener('click', (e) => {
                    if (e.target.classList.contains('btn-add')) {
                        const template = document.getElementById(e.target.dataset.template);
                        const container = document.getElementById(e.target.dataset.container);
                        if (template && container) {
                            container.appendChild(template.content.cloneNode(true));
                        }
                    }
                    if (e.target.classList.contains('btn-remove')) {
                        e.target.closest('.dynamic-row').remove();
                    }
                });
            },

            initWizard() {
                this.steps = document.querySelectorAll('.form-step');
                this.totalSteps = this.steps.length;
                this.progressBar = document.getElementById('progressBar');
                this.nextBtn = document.getElementById('nextBtn');
                this.prevBtn = document.getElementById('prevBtn');
                this.generatePdfBtn = document.getElementById('generatePdf');
                
                this.renderProgressBar();
                this.updateWizardState();

                this.nextBtn.addEventListener('click', () => this.changeStep(1));
                this.prevBtn.addEventListener('click', () => this.changeStep(-1));
            },

            renderProgressBar() {
                let stepsHtml = '';
                this.steps.forEach((step, index) => {
                    const i = index + 1;
                    const stepLabel = step.dataset.label || `Krok ${i}`;
                    stepsHtml += `
                        <div class="progress-step" data-step="${i}">
                            <div class="step-circle">${i}</div>
                            <div class="step-label">${stepLabel}</div>
                        </div>
                    `;
                });
                this.progressBar.innerHTML = stepsHtml;
            },

            updateWizardState() {
                this.steps.forEach(step => {
                    step.classList.toggle('active', parseInt(step.dataset.step) === this.currentStep);
                });

                const progressSteps = this.progressBar.querySelectorAll('.progress-step');
                progressSteps.forEach(step => {
                    const stepNum = parseInt(step.dataset.step);
                    step.classList.toggle('active', stepNum === this.currentStep);
                    step.classList.toggle('completed', stepNum < this.currentStep);
                });

                this.prevBtn.disabled = this.currentStep === 1;
                this.nextBtn.style.display = this.currentStep === this.totalSteps ? 'none' : 'inline-block';
                this.generatePdfBtn.style.display = this.currentStep === this.totalSteps ? 'inline-block' : 'none';
            },

            changeStep(direction) {
                if (direction > 0) {
                    const currentStepElement = document.querySelector(`.form-step[data-step="${this.currentStep}"]`);
                    let isStepValid = true;
                    currentStepElement.querySelectorAll('input[required], select[required]').forEach(field => {
                        if (!this.validateField(field)) isStepValid = false;
                    });
                    if (!isStepValid) {
                        alert('Proszę wypełnić wszystkie wymagane pola w tym kroku.');
                        return;
                    }
                }
                const newStep = this.currentStep + direction;
                if (newStep > 0 && newStep <= this.totalSteps) {
                    this.currentStep = newStep;
                    this.updateWizardState();
                }
            },
            
            async generatePdf() {
                this.loader.style.display = 'flex';
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    doc.setFont('Helvetica', 'normal');

                    const MARGIN = 15, PAGE_WIDTH = doc.internal.pageSize.getWidth(), PAGE_HEIGHT = doc.internal.pageSize.getHeight();
                    let yPos = MARGIN, pageNum = 1;

                    const checkPageBreak = (heightNeeded) => {
                        if (yPos + heightNeeded > PAGE_HEIGHT - MARGIN) {
                            doc.text(`Strona ${pageNum}`, PAGE_WIDTH - MARGIN, PAGE_HEIGHT - 10, { align: 'right' });
                            doc.addPage();
                            yPos = MARGIN;
                            pageNum++;
                        }
                    };
                    const drawSectionTitle = (title) => {
                        checkPageBreak(20); yPos += 10;
                        doc.setFontSize(14); doc.setFont('Helvetica', 'bold'); doc.setTextColor('#1f2937');
                        doc.text(title, MARGIN, yPos); yPos += 8;
                    };
                    const drawSubSectionTitle = (title) => {
                        checkPageBreak(15); yPos += 8;
                        doc.setFontSize(12); doc.setFont('Helvetica', 'bold'); doc.setTextColor('#374151');
                        doc.text(title, MARGIN, yPos); yPos += 6;
                    };
                    const drawKeyValue = (label, value) => {
                        checkPageBreak(10);
                        doc.setFontSize(10); doc.setFont('Helvetica', 'normal'); doc.setTextColor('#6b7280');
                        doc.text(label, MARGIN, yPos);
                        doc.setTextColor('#1f2937');
                        doc.text(value || '---', MARGIN + 60, yPos);
                        yPos += 7;
                    };
                    const drawTable = (headers, data, emptyText) => {
                        if (!data || data.length === 0) {
                            checkPageBreak(15); doc.setFontSize(10); doc.setTextColor('#6b7280');
                            doc.text(emptyText, MARGIN, yPos); yPos += 10; return;
                        }
                        doc.autoTable({
                            head: [headers], body: data, startY: yPos, theme: 'grid',
                            headStyles: { fillColor: [243, 244, 246], textColor: [29, 41, 51], font: 'Helvetica', fontStyle: 'bold' },
                            styles: { font: 'Helvetica', fontStyle: 'normal', cellPadding: 2, fontSize: 9 },
                            didDrawPage: (data) => {
                                pageNum = doc.internal.getNumberOfPages();
                                doc.setFontSize(9); doc.setTextColor('#6b7280');
                                doc.text(`Strona ${pageNum}`, PAGE_WIDTH - MARGIN, PAGE_HEIGHT - 10, { align: 'right' });
                            }
                        });
                        yPos = doc.autoTable.previous.finalY + 10;
                    };
                    
                    doc.setFontSize(18); doc.setFont('Helvetica', 'bold'); doc.setTextColor('#d90000');
                    doc.text('Wniosek o Umowę Ramową', PAGE_WIDTH / 2, yPos, { align: 'center' });
                    yPos += 15;
                    
                    const getVal = (id) => document.getElementById(id)?.value || '';
                    const getTableData = (containerId, fields) => {
                        const container = document.getElementById(containerId);
                        if (!container) return [];
                        return Array.from(container.querySelectorAll('.dynamic-row')).map(row => 
                            fields.map(field => row.querySelector(`[name^="${field}"]`)?.value || '---')
                        );
                    };

                    drawSectionTitle('I. Dane wnioskodawcy');
                    drawSubSectionTitle('1. Dane adresowe');
                    drawKeyValue('Pełna nazwa firmy:', getVal('fullName'));
                    drawKeyValue('NIP:', getVal('nip'));
                    drawKeyValue('REGON:', getVal('regon'));
                    drawKeyValue('Telefon:', getVal('phone'));
                    drawKeyValue('E-mail:', getVal('email'));
                    
                    drawSubSectionTitle('2. Reprezentacja i kontakt');
                    drawKeyValue('Osoba reprezentująca:', getVal('rep_name'));
                    drawKeyValue('Telefon (reprezentant):', getVal('rep_phone'));
                    drawKeyValue('E-mail (reprezentant):', getVal('rep_email'));

                    drawSectionTitle('II. Informacje o Firmie');
                    drawSubSectionTitle('Właściciele');
                    drawTable(['Nazwisko / nazwa', 'Udziały (%)'], getTableData('owners-container', ['owner_name', 'owner_shares_percent']), 'Brak właścicieli.');

                    drawSubSectionTitle('Wnioskowany limit');
                    drawKeyValue('Limit wadialny:', getVal('limit_wadialny') + ' PLN');
                    drawKeyValue('Limit kontraktowy:', getVal('limit_kontrakt') + ' PLN');

                    drawSectionTitle('III. Sytuacja Finansowa');
                    drawSubSectionTitle('Rachunki bankowe');
                    drawTable(['Nazwa banku', 'Numer rachunku'], getTableData('accounts-container', ['bank_name', 'account_number']), 'Brak rachunków.');
                    
                    drawSubSectionTitle('Kredyty');
                    drawTable(['Bank', 'Kwota do spłaty'], getTableData('credits-container', ['credit_bank', 'credit_amount']), 'Brak kredytów.');

                    doc.text(`Strona ${pageNum}`, PAGE_WIDTH - MARGIN, PAGE_HEIGHT - 10, { align: 'right' });
                    doc.save('wniosek-kreator.pdf');

                } catch (error) {
                    console.error("Błąd podczas generowania PDF:", error);
                    alert("Wystąpił błąd: " + error.message);
                } finally {
                    this.loader.style.display = 'none';
                }
            },
            
            validateField(field) {
                let isValid = field.checkValidity();
                field.classList.toggle('is-invalid', !isValid);
                return isValid;
            },
        };

        App.init();
    });
  </script>
</body>
</html>
